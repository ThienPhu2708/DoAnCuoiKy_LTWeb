@{
    ViewBag.Title = "Bảng điều khiển & Thống kê";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<h1 class="text-3xl font-bold text-gray-800 mb-6">
    @ViewBag.Title
</h1>

<!-- ===== Thẻ Thống kê nhanh ===== -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">

    <!-- Card 1: Doanh thu (Requirement 1) -->
    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between transition transform hover:scale-105">
        <div>
            <div class="text-sm font-medium text-gray-500 uppercase">Doanh thu (Tháng này)</div>
            <div class="text-3xl font-bold text-gray-900 mt-1">@String.Format("{0:N0} VNĐ", ViewBag.RevenueMonth ?? 0)</div>
            <div class="text-sm text-green-500 mt-1 flex items-center">
                <i class="fas fa-arrow-up mr-1"></i>
            </div>
        </div>
        <div class="text-5xl text-blue-500 opacity-70">
            <i class="fas fa-wallet"></i>
        </div>
    </div>

    <!-- Card 2: Đơn hàng mới (Requirement 2) -->
    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between transition transform hover:scale-105">
        <div>
            <div class="text-sm font-medium text-gray-500 uppercase">Đơn hàng mới (Trong tháng)</div>
            <div class="text-3xl font-bold text-gray-900 mt-1">@(ViewBag.NewOrdersMonth ?? 0)</div>
            <div class="text-sm text-gray-500 mt-1">
                Tổng @(ViewBag.TotalOrdersMonth ?? 0) đơn hàng tháng này
            </div>
        </div>
        <div class="text-5xl text-yellow-500 opacity-70">
            <i class="fas fa-box-open"></i>
        </div>
    </div>

    <!-- Card 3: Đơn hàng hoàn thành -->
    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between transition transform hover:scale-105">
        <div>
            <div class="text-sm font-medium text-gray-500 uppercase">Đơn hoàn thành (Tháng này)</div>
            <div class="text-3xl font-bold text-gray-900 mt-1">@(ViewBag.CompletedOrdersMonth ?? 0)</div>
            <div class="text-sm text-green-500 mt-1 flex items-center">
                <i class="fas fa-check-circle mr-1"></i>
                Tỷ lệ: @((ViewBag.TotalOrdersMonth ?? 0) == 0 ? "0%" : ((double)ViewBag.CompletedOrdersMonth / (double)ViewBag.TotalOrdersMonth).ToString("P0"))
            </div>
        </div>
        <div class="text-5xl text-green-500 opacity-70">
            <i class="fas fa-truck-loading"></i>
        </div>
    </div>

    <!-- Card 4: Tỷ lệ hủy đơn -->
    <div class="bg-white p-6 rounded-xl shadow-lg flex items-center justify-between transition transform hover:scale-105">
        <div>
            <div class="text-sm font-medium text-gray-500 uppercase">Đơn đã hủy (Tháng này)</div>
            <div class="text-3xl font-bold text-gray-900 mt-1">@(ViewBag.CancelledOrdersMonth ?? 0)</div>
            <div class="text-sm text-red-500 mt-1 flex items-center">
                <i class="fas fa-ban mr-1"></i>
                Tỷ lệ hủy: @(((double?)ViewBag.CancellationRateMonth ?? 0).ToString("P0"))
            </div>
        </div>
        <div class="text-5xl text-red-500 opacity-70">
            <i class="fas fa-ban"></i>
        </div>
    </div>
</div>

<!-- ===== Khu vực Biểu đồ ===== -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

    <!-- Biểu đồ 1: Thống kê Doanh thu  -->
    <div class="bg-white p-6 rounded-xl shadow-lg lg:col-span-2">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-700">Thống kê Doanh thu (7 ngày qua)</h2>
        </div>
        <!-- Canvas để Chart.js vẽ biểu đồ -->
        <div class="h-80">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>

    <!-- Biểu đồ 2: -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Trạng thái Đơn hàng (Tháng này)</h2>
        <!-- Canvas để Chart.js vẽ biểu đồ -->
        <div class="h-80">
            <canvas id="productDoughnutChart"></canvas>
        </div>
    </div>

</div>

<!-- ===== Bảng: Đơn hàng gần đây  ===== -->
<div class="bg-white p-6 rounded-xl shadow-lg">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">Đơn hàng Gần đây</h2>

    <!-- Bảng -->
    <div class="overflow-x-auto rounded-lg border border-gray-200">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã Đơn</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khách hàng</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày đặt</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng tiền</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Chi tiết</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                @if (ViewBag.RecentOrders != null && ((List<DoAn_LTWeb.Models.DONDATHANG>)ViewBag.RecentOrders).Any())
                {
                    foreach (var order in (List<DoAn_LTWeb.Models.DONDATHANG>)ViewBag.RecentOrders)
                    {
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                #@order.MADON
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                @(order.KHACHHANG?.HOTEN ?? "Khách vãng lai")
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                @(order.NGAYDAT.HasValue ? order.NGAYDAT.Value.ToString("dd/MM/yyyy") : "N/A")
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-700">
                                @String.Format("{0:N0} VNĐ", order.TONGTIEN)
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <!-- Logic badge trạng thái -->
                                @{
                                    string statusClass = "bg-gray-100 text-gray-800";
                                    string statusText = order.TRANGTHAIDON ?? "Không rõ";
                                    switch (statusText.ToLower())
                                    {
                                        case "chờ xử lý": statusClass = "bg-yellow-100 text-yellow-800"; break;
                                        case "đang giao": case "đã xác nhận": statusClass = "bg-blue-100 text-blue-800"; break;
                                        case "đã hoàn thành": statusClass = "bg-green-100 text-green-800"; break;
                                        case "đã hủy": statusClass = "bg-red-100 text-red-800"; break;
                                    }
                                }
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full @statusClass">
                                    @statusText
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                <a href="@Url.Action("OrderDetails", "Admin", new { id = order.MADON })" class="text-blue-600 hover:text-blue-900" title="Xem chi tiết">
                                    <i class="fas fa-eye fa-fw"></i>
                                </a>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500 italic">Không có đơn hàng nào gần đây.</td>
                    </tr>
                }
                <!-- Hết dữ liệu mẫu -->
            </tbody>
        </table>
    </div>
</div>


<!-- ===== SCRIPT ĐỂ VẼ BIỂU ĐỒ ===== -->
@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        function getRandomColor() {
            var r = Math.floor(Math.random() * 255);
            var g = Math.floor(Math.random() * 255);
            var b = Math.floor(Math.random() * 255);
            return `rgb(${r},${g},${b})`;
        }

        // Đợi DOM load xong
        document.addEventListener("DOMContentLoaded", function () {
            fetch('@Url.Action("GetRevenueChartData", "Admin")')
                .then(response => response.json())
                .then(apiData => {

                    const revenueData = {
                        labels: apiData.labels, 
                        datasets: [{
                            label: 'Doanh thu (VNĐ)',
                            data: apiData.data, 
                            borderColor: 'rgb(59, 130, 246)', 
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    };

                    const revenueConfig = {
                        type: 'line',
                        data: revenueData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function (value, index, values) {
                                            return new Intl.NumberFormat('vi-VN').format(value) + ' VNĐ';
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            return context.dataset.label + ': ' + new Intl.NumberFormat('vi-VN').format(context.parsed.y) + ' VNĐ';
                                        }
                                    }
                                }
                            }
                        }
                    };

                    // Vẽ biểu đồ Doanh thu
                    const revenueChartCtx = document.getElementById('revenueChart').getContext('2d');
                    new Chart(revenueChartCtx, revenueConfig);
                })
                .catch(error => console.error('Lỗi tải dữ liệu Biểu đồ Doanh thu:', error));

            fetch('@Url.Action("GetOrderStatusChartData", "Admin")')
                .then(response => response.json())
                .then(apiData => {

                    // Xử lý dữ liệu trả về 
                    const labels = [];
                    const data = [];
                    const backgroundColors = [];

                    apiData.forEach(item => {
                        labels.push(item.Status);
                        data.push(item.Count);
                        // Gán màu dựa trên trạng thái 
                        switch (item.Status.toLowerCase()) {
                            case "chờ xử lý": backgroundColors.push('rgb(245, 158, 11)'); break; 
                            case "đã hoàn thành": backgroundColors.push('rgb(16, 185, 129)'); break; 
                            case "đã hủy": backgroundColors.push('rgb(239, 68, 68)'); break; 
                            case "đang giao": backgroundColors.push('rgb(59, 130, 246)'); break;
                             case "đã xác nhận": backgroundColors.push('rgb(59, 130, 246)'); break;
                            default: backgroundColors.push(getRandomColor());
                        }
                    });

                    const statusData = {
                        labels: labels,
                        datasets: [{
                            label: 'Số lượng đơn',
                            data: data,
                            backgroundColor: backgroundColors,
                            hoverOffset: 4
                        }]
                    };

                    const statusConfig = {
                        type: 'doughnut',
                        data: statusData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom', 
                                    labels: {
                                        padding: 15
                                    }
                                }
                            }
                        }
                    };

                    // Vẽ biểu đồ Trạng thái
                    const statusChartCtx = document.getElementById('productDoughnutChart').getContext('2d');
                    new Chart(statusChartCtx, statusConfig);
                })
                .catch(error => console.error('Lỗi tải dữ liệu Biểu đồ Trạng thái:', error));
        });
    </script>
}